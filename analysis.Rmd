---
title: "analysis mouse asymetry"
output: github_document
author: "Joanes Grandjean
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r load libraries}
#tidy stuff
library(tidyverse,warn.conflicts = FALSE)
library(glue,warn.conflicts = FALSE)

#easystat
library(datawizard,warn.conflicts = FALSE)
library(effectsize)
library(report)
```


## load main assets
```{r load global variables}

study <-
  read_csv('asset/study_stable.csv', col_types = cols()) %>% select(
    Mouse_ID,
    POND_Mouse_ID,
    Study_Name,
    Is_Wildtype,
    Genotype,
    MGI_Genotype,
    Background,
    MGI_Background,
    Mouse_Weight,
    Mouse_Age,
    Mouse_Sex,
    Scan_Type,
    Scan_Coil,
    Scan_Date,
    Scan_Operator,
    Isotropic_Voxel_Resolution
  ) %>% mutate(Mouse_Age = replace(Mouse_Age, Mouse_Age == "(Empty)", "P040")) %>% 
        mutate(Mouse_Age = gsub("P", '', .$Mouse_Age)) %>% 
        mutate(Mouse_Age = replace(Mouse_Age, Mouse_Age == "058-062", "060")) %>% 
        mutate(Mouse_Age = replace(Mouse_Age, Mouse_Age == "070-077", "073")) %>% 
        mutate(Mouse_Age = replace(Mouse_Age, Mouse_Age == "224-245", "235")) %>% 
        mutate(Mouse_Age = replace(Mouse_Age, Mouse_Age == "098-168", "133")) %>% 
        mutate(Mouse_Age = replace(Mouse_Age, Mouse_Age == "154-161", "157")) %>% 
        mutate(Mouse_Age =as.numeric(.$Mouse_Age)) %>% 
        mutate(Genotype = as_factor(Genotype)) %>% 
        mutate(Mouse_Sex = as_factor(Mouse_Sex)) %>% mutate(Is_Wildtype = as_factor(Is_Wildtype)) %>% 
        mutate(Background = as_factor(Background))

roi_merge <-
  read_csv('asset/roi_label_clean.csv', col_types = cols())

data_path <- '/project/4180000.24/asym/proc/absolute/'


```



## load AI per ROI

NOTE, redo PND36_HSC_0001_01_SE01_MR.txt

```{r get all ROI_AI values}
roi_AI_list <-
  file.path(data_path, 'roi_AI') %>% dir() %>% gsub("_01_SE01_MR.txt", "", .)

roi_AI_mat <- array(NA, dim = c(dim(study)[1], dim(roi_merge)[1]))

for (i in 1:dim(study)[1]) {
  roi_AI_file <- which(roi_AI_list %in% study$POND_Mouse_ID[i])
  if (length(roi_AI_file) == 1) {
    roi_AI_mat[i, ] <-
      read_table(
        file.path(
          data_path,
          'roi_AI',
          glue('{roi_AI_list[roi_AI_file]}_01_SE01_MR.txt')
        ),
        col_names = FALSE,
        col_types = cols()
      ) %>%  pivot_longer(everything()) %>% data_extract(value)
  }
  
}

```




```{r test stats}


study_name <- unique(study$Study_Name)

AI_var_ratio <- array(NA, dim = c(dim(roi_merge)[1], length(study_name)))
AI_var_lower <- array(NA, dim = c(dim(roi_merge)[1], length(study_name)))
AI_var_upper <- array(NA, dim = c(dim(roi_merge)[1], length(study_name)))
AI_var_sign <- array(NA, dim = c(dim(roi_merge)[1], length(study_name)))

AI_hedges_g <- array(NA, dim = c(dim(roi_merge)[1], length(study_name)))
AI_hedges_lower <-
  array(NA, dim = c(dim(roi_merge)[1], length(study_name)))
AI_hedges_upper <-
  array(NA, dim = c(dim(roi_merge)[1], length(study_name)))
AI_hedges_sign <-
  array(NA, dim = c(dim(roi_merge)[1], length(study_name)))


for (i in 1:dim(roi_merge)[1]) {
  study$AI <- roi_AI_mat[, i]
  
  
  for (j in 1:length(study_name)) {
    study_sub <- study[study$Study_Name == study_name[j], ]
    Tg <- study_sub$AI[study_sub$Is_Wildtype == 'MUT']
    Wt <- study_sub$AI[study_sub$Is_Wildtype == 'WT']
    
    if (sum(is.na(Wt)) == length(Wt)) {
      next
    }
    if (sum(is.na(Tg)) == length(Tg)) {
      next
    }
    
    
    AI_var <- var.test(Tg, Wt)
    AI_var_ratio[i, j] <- AI_var$estimate[[1]]
    AI_var_lower[i, j] <- AI_var$conf.int[1]
    AI_var_upper[i, j] <- AI_var$conf.int[2]
    AI_var_sign[i, j] <-
      sign(AI_var$conf.int[2]) == sign(AI_var$conf.int[1])
    
    AI_g <- hedges_g(Tg, Wt)
    AI_hedges_g[i, j] <- AI_g$Hedges_g
    AI_hedges_lower[i, j] <- AI_g$CI_low
    AI_hedges_upper[i, j] <- AI_g$CI_high
    AI_hedges_sign[i, j] <- sign(AI_g$CI_high) == sign(AI_g$CI_low)
    
  }
}




```




